---
title: "README_short"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message = FALSE}
library(data.table)
library(dplyr)
library(stringr) #this should be already added to the cytotypr package but it won't knit without
library(tidyr)
library(tibble)
library(ggplot2)
library(readxl)
library(broom)
library(purrr)
library(cytotypr) # this is my package
```

## Convert flowSet to "tidy data" format

Now that the initial gating has been applied, to limit the data to measurements oflive, singlet lymphocyte cells, we convert the data to a "tidy data" format, to allow us to work with "tidyverse" tools for further analysis and visualization.

Apply this function to the 'flowSet' of gated FMO data:

```{r}
FMO_gated_data <- tidy_flow_set(flowset_FMO_gated_data)
FMO_gated_data
```


```{r}
# note that here the filename and the column marker names need to match exactly
df_FMO_gated_data <- FMO_gated_data %>%
  dplyr::select(ends_with("-A"), -`FSC-A`, `SSC-A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC-A",
         `CD44` = "APC-Fire 750-A",
        `CD103` =  "APC-R700-A",       
         `CD3` = "Alexa Fluor 532-A",
         `Sca1` = "BB515-A",
         `IL_10` = "BV421-A",
         `CD4` = "BV480-A",
         `CD69` = "BV510-A",
         `CD8` = "BV570-A", 
         `CTLA4` = "BV605-A",
         `CD27` = "BV650-A",
         `CD153` = "BV711-A",
         `KLRG1` = "BV785-A",
         `IL_17` = "PE-A",
         `CD122` = "PE-Cy5-A",
         `IFN` = "PE-Cy7-A", 
         `CD62L` = "PE-Dazzle594-A",
         `TNF` = "Pacific Blue-A", 
         `CD28` = "PE-Cy5.5-A",
         `PD1` = "PerCP-eFluor 710-A")  %>%
   na.omit()%>%
  dplyr::filter(`SSC-A` != max(`SSC-A`)) %>%
  dplyr::mutate(filename = str_replace(filename, ".fcs", "")) %>%
  dplyr::mutate(filename = str_replace(filename, "IFNG", "IFN"))

  
FMO_filtered_data <- filter_FMO(df_FMO_gated_data)

add_quantile <- get_99(FMO_filtered_data)

plot_FMOs(FMO_filtered_data, add_quantile)
```

# Gated Data
Pull out the gated data

```{r}
# tidy the flowset and convert to a dataframe
df_all_gated <-  tidy_flow_set(flowset_gated_data) 

unique(df_all_gated$filename)
```

# Feature engineer the data

Feature cut the data to get all of the possible populations for each file with the cell count and number of cells. Feature engineering is based on the 99%.

Remove FoxP3
Remove CD69 - spreading from Sca1 makes the marker unusable

```{r}
all_fe <- df_all_gated %>%
  mutate(Timepoint = str_extract(filename, "D[0-9]*")) %>%
  mutate(Group = str_extract(filename, "Group[:punct:][0-9][:punct:][A-Z]"),
         Group = str_replace(Group, "Group_", "")) %>%
  unite(filename, c("Timepoint", "Group")) %>%
  select(ends_with("-A"), -`FSC-A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC-A",
         `CD44` = "APC-Fire 750-A",
        `CD103` =  "APC-R700-A",       
         `CD3` = "Alexa Fluor 532-A",
         `Sca1` = "BB515-A",
         `IL_10` = "BV421-A",
         `CD4` = "BV480-A",
         `CD69` = "BV510-A",
         `CD8` = "BV570-A", 
         `CTLA4` = "BV605-A",
         `CD27` = "BV650-A",
         `CD153` = "BV711-A",
         `KLRG1` = "BV785-A",
         `IL_17` = "PE-A",
         `CD122` = "PE-Cy5-A",
         `IFN` = "PE-Cy7-A", 
         `CD62L` = "PE-Dazzle594-A",
         `TNF` = "Pacific Blue-A", 
         `CD28` = "PE-Cy5.5-A",
         `PD1` = "PerCP-eFluor 710-A") %>%
  dplyr::filter(`SSC-A` != max(`SSC-A`)) %>%
  mutate(CD3 = fe(add_quantile, CD3, "CD3"),
         CD4 = fe(add_quantile, CD4, "CD4"),
         CD8 = fe(add_quantile, CD8, "CD8"),
         CD44 = fe(add_quantile, CD44, "CD44"),
         CD103 = fe(add_quantile, CD103, "CD103"),
         Sca1 = fe(add_quantile, Sca1, "Sca1"),
         IL_17 = fe(add_quantile,IL_17, "IL_17"),
         CD69 = fe(add_quantile,CD69, "CD69"),
         CTLA4 = fe(add_quantile,CTLA4, "CTLA4"),
         CD27 = fe(add_quantile,CD27, "CD27"),
         CD153 = fe(add_quantile,CD153, "CD153"),
         KLRG1 = fe(add_quantile,KLRG1, "KLRG1"),
         IFN = fe(add_quantile,IFN, "IFN"),
         FoxP3 = fe(add_quantile,FoxP3, "FoxP3"),
         CD122 = fe(add_quantile,CD122, "CD122"),
         PD1 = fe(add_quantile,PD1, "PD1"),
         CD62L = fe(add_quantile,CD62L, "CD62L"),
         IL_10 = fe(add_quantile,IL_10, "IL_10"),
         CD28 = fe(add_quantile,CD28, "CD28"),
         TNF = fe(add_quantile,TNF, "TNF")) %>%
  select(-`Zombie Nir-A`, -`AF-A`, -`SSC-A`, -FoxP3, -CD69) %>%
  count_calc()

```

# Visulatizations

Initial identification of populations plot

We first want to view all of the different cell phenotypes within the data

```{r}
# this is the order of markers that we want for all of our plots
order_of_markers <- c("CD3", "CD4", "CD8",  "CD44", "CD103", "Sca1", "IL_17","CTLA4",
                      "CD27",  "CD153", "KLRG1", "IFN",  "CD122", "PD1", "CD62L",
                      "IL_10", "CD28","TNF")

# to view all of the possible combinations
total_phenotypes <- filter_for_total_pheno(all_fe, marker_order = order_of_markers)

heatmap_all_pheno(total_phenotypes)

# gives the total number of populations
nrow(total_phenotypes) 
```

After identifying all phenotypes, we can filter the data to see the ones that we're interested in, for example, CD3+ cells that constitute >0.5% of total live leukocytes in a sample.

```{r}
# view the specific cell phenotypes we're interested in
sample_populations <- all_fe %>%
  dplyr::filter(CD3 == 1 & percentage > 0.5) %>%
  filter_pops() 

sample_populations_all_groups <- identified_pop_perc(sample_populations, all_fe, marker_vector = order_of_markers)
```

Plot sample populations
```{r fig.width = 2, fig.height = 2.5}

############ Simple plot - sample populations #######################

simple_pop_df <- sample_populations %>%
  column_to_rownames("population") 

simple_pop_df %>%
  dplyr::select(all_of(order_of_markers)) %>%
  mutate_all(~convert_factor_numeric(.)) %>%
    pheatmap::pheatmap(cluster_rows = FALSE, cluster_cols = FALSE,
             labels_row = rownames(simple_pop_df),
             cellwidth = 15, cellheight = 15, angle_col = 45, 
             color = c("#3F4788FF", "#56C667FF"), cutree_rows = 2, legend = FALSE)

```

Correlation plot

```{r}

########### Basic example with ggplot ###############################

corr <- calc_corr(sample_populations_all_groups)

melted_corr <- format_corr(corr)
  
plot_corr(melted_corr) +
    ggplot2::xlab("Populations") +
    ggplot2::ylab("Populations") +
    ggplot2::labs(fill = "Correlation") 

```

Time Series Plot 
```{r}
########### Basic time series example ###############################

# take the data for filtered populations and rename so that plots are pretty
pops_for_plots_average <- sample_populations_all_groups %>%
  separate(filename, into = c("Timepoint", "Group", "Number"), sep = "_") %>%
  dplyr::group_by(population, Timepoint, Group) %>%
  dplyr::mutate(average_percent = mean(percentage)) %>%
  select(-Number, -percentage) %>%
  ungroup() %>%
  unique() %>%
  dplyr::mutate(Group = str_replace(Group, "1", "PBS"),
         Group = str_replace(Group, "2", "BCG")) %>%
  dplyr::mutate(Timepoint = str_replace(Timepoint, "D30", "30"),
         Timepoint = str_replace(Timepoint, "D60", "60"),
         Timepoint = str_replace(Timepoint, "D90", "90")) %>%
  mutate(Group = str_replace(Group, "PBS", "Control"),
         Group = str_replace(Group, "BCG", "Vaccinated")) %>%
  mutate(population = factor(population, 
                             levels = paste0("Pop", c(1:length(unique(population))))))


ggplot(pops_for_plots_average, aes(x = factor(Timepoint, levels = c("30", "60", "90")),
                                 y = average_percent, group = Group, color = Group)) +
  scale_fill_identity() +
  geom_point() +
  geom_line() +
  facet_wrap("population", scales = "free", ncol = 7) +
  xlab("Days Post-Infection") +
  ylab("Average Percent of Total Live Leukocytes") +
  theme_gray() +
    theme(axis.text.x = element_text(angle = 45, size = 8, hjust = 1),
        axis.text.y = element_text(size = 6),
        strip.text.x = element_text(size = 8),
        axis.title = element_text(size = 10),
        title = element_text(size = 10),
        legend.text = element_text(size=8),
        legend.key.size = unit(1, "line"))

```

Data Visualization

- CFU Correlation

```{r fig.width = 3.5, fig.height= 3.5}
############### Simple CFU plotting ###########################

CFUs <- readxl::read_xlsx("./inst/extdata/CFU_data.xlsx") %>%
  dplyr::filter(Organ == "Lung") %>%
  dplyr::filter(Group == "1" | Group == "2")

# clean the flow data and prepare to join with CFU
pops_for_CFUs <- sample_populations_all_groups %>%
  separate(filename, into = c("Timepoint", "Group", "Number"), sep = "_") %>%
  dplyr::mutate(Timepoint = str_replace(Timepoint, "D", "")) %>%
  dplyr::mutate(Timepoint = as.numeric(Timepoint),
                Group = as.numeric(Group)) 

# join together the CFU data and the population data
pops_CFUs <- inner_join(pops_for_CFUs, CFUs, by = c("Group", "Number", "Timepoint")) %>%
  mutate(population = factor(population, levels = paste0("Pop", c(1:length(unique(population))))))

# calculate statistical significance


fitted_models <- pops_CFUs %>%
  group_by(population) %>%
  nest() %>%
  mutate(model = map(data, ~lm(percentage ~ CFU, data = .)),
         tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(population, adj.r.squared, p.value)


##### these should get the same values because the length of p.value is also 33, but they arent
fitted_models %>%
  mutate(p.val.adj = p.adjust(p.value, method = "bonferroni", 
                              n = 33)) %>%
  mutate("Significance" = p.val.adj < 0.05) %>%
  rename("p-value" = p.value,
         "Adjusted p-value" = p.val.adj) 

fitted_models %>%
  mutate(p.val.adj = p.adjust(p.value, method = "bonferroni", 
                              n = length(fitted_models$p.value))) %>%
  mutate("Significance" = p.val.adj < 0.05) %>%
  rename("p-value" = p.value,
         "Adjusted p-value" = p.val.adj) 

fitted_models %>%
  mutate(p.val.adj = p.adjust(p.value, method = "bonferroni", 
                              n = length(p.value))) %>%
  mutate("Significance" = p.val.adj < 0.05) %>%
  rename("p-value" = p.value,
         "Adjusted p-value" = p.val.adj) 

fitted_models %>%
  mutate(p.val.adj = p.adjust(p.value, method = "bonferroni")) %>%
  mutate("Significance" = p.val.adj < 0.05) %>%
  rename("p-value" = p.value,
         "Adjusted p-value" = p.val.adj) 

length(fitted_models$p.value)


```

Using geom_label instead of stat_smooth_fun 
```{r fig.width = 3.5, fig.height= 3.5}

########################### try geom_text from a separate dataframe  #######
# problem with the placement of the labels because I'm using free_x in the facet_wrap
# but when I remove the free_x, the data is scrunched up on the y-axis

values_for_plot <- fitted_models %>%
  mutate(p.val.adj = p.adjust(p.value, method = "bonferroni", 
                              n = length(fitted_models$p.value))) 

r_labeling <- left_join(pops_CFUs, values_for_plot, by = "population") %>%
  group_by(population) %>%
  mutate(average_percentage = mean(percentage)) %>%
  select(population, average_percentage, adj.r.squared, p.val.adj) %>%
  unique()

ggplot(pops_CFUs) +
  scale_fill_identity() +
  geom_point(aes(percentage, CFU), color = "black") +
  geom_smooth(aes(x = percentage, y = CFU), method = "lm", se = FALSE, color = "#3F4788FF") +
  geom_text(data = r_labeling, aes(x = average_percentage, y = 5, 
                                   label = paste("r^2 = ", round(adj.r.squared, 3)))) +
  facet_wrap(~population, scales = "free_x", ncol = 8) +
  xlab("Percentage of Cells") +
  ylab("log10 CFU") +
  ggtitle("Population and CFU Linear regression") +
  theme(axis.text.x = element_text(size = 9, hjust = 1),
        axis.text.y = element_text(size = 9),
        axis.title = element_text(size = 15),
        title = element_text(size = 17))

```

Try CFU/flow plots that will fit in README
```{r}

########################### try geom_text from a separate dataframe  #######
# problem with the placement of the labels because I'm using free_x in the facet_wrap
# but when I remove the free_x, the data is scrunched up on the y-axis

values_for_plot <- fitted_models %>%
  mutate(p.val.adj = p.adjust(p.value, method = "bonferroni", 
                              n = length(fitted_models$p.value))) 

r_labeling <- left_join(pops_CFUs, values_for_plot, by = "population") %>%
  group_by(population) %>%
  mutate(average_percentage = mean(percentage)) %>%
  select(population, average_percentage, adj.r.squared, p.val.adj) %>%
  unique()

ggplot(pops_CFUs) +
  scale_fill_identity() +
  geom_point(aes(percentage, CFU), color = "black", size = 1) +
  geom_smooth(aes(x = percentage, y = CFU), method = "lm", se = FALSE, color = "#3F4788FF") +
  geom_text(data = r_labeling, aes(x = average_percentage, y = 5, 
                                   label = paste("r^2 = ", round(adj.r.squared, 3))), size = 3) +
  facet_wrap(~population, scales = "free_x", ncol = 8) +
  xlab("Percentage of Cells") +
  ylab("log10 CFU") +
  ggtitle("Population and CFU Linear regression") +
  theme(axis.text.x = element_text(size = 6, hjust = 1),
        axis.text.y = element_text(size = 6),
        axis.title = element_text(size = 10),
        title = element_text(size = 10))

```



